<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Todo List</title>
	<link rel="stylesheet" href="/assets/css/base.css">
	<link rel="stylesheet" href="/assets/css/index.css">
	<link rel="stylesheet" href="/js/nprogress/nprogress.css">
</head>

<body>
	<section class="todoapp">
		<header class="header">
			<h1>todos</h1>
			<input class="new-todo" placeholder="What needs to be done?" autofocus id="task">
		</header>
		<!-- This section should be hidden by default and shown when there are todos -->
		<section class="main">
			<input class="toggle-all" type="checkbox">
			<label for="toggle-all">Mark all as complete</label>
			<ul class="todo-list" id="todo-list"></ul>
		</section>
		<footer class="footer">
			<span class="todo-count"><strong id="count">0</strong> item left</span>
			<ul class="filters">
				<li class="selected" data-status="task">
					<a href="#all">All</a>
				</li>
				<li data-status="active">
					<a href="#active">Active</a>
				</li>
				<li data-status="completed">
					<a href="#completed">Completed</a>
				</li>
			</ul>
			<!-- Hidden if no completed items are left ↓ -->
			<button class="clear-completed">Clear completed</button>
		</footer>
	</section>
	<script src="/js/jquery.min.js"></script>
	<script src="/js/template-web.js"></script>
	<script src="/js/nprogress/nprogress.js"></script>
	<script type="text/html" id="taskTpl">
			{{each tasks}}
			<li class="{{$value.completed ? 'completed' : ''}}">
				<div class="view">
					<input class="toggle" type="checkbox" {{$value.completed ? 'checked' : ''}}>
					<label>{{$value.title}}</label>
					<button class="destroy" data-id="{{@$value._id}}"></button>
				</div>
				<input class="edit" value="Rule the web">
			</li>
			{{/each}}
		</script>
	<script>
		// 存放任务列表
		let taskBox = $('#todo-list');
		let taskInp = $('#task');
		let strong = $('#count')

		// 页面中有请求发送时触发
		$(document).on('ajaxStart', function () {
			NProgress.start();
		});
		// 页面中有请求完成时触发
		$(document).on('ajaxComplete', function () {
			NProgress.done();
		});
		if (!location.hash) location.hash = '#all';
		// 添加
		taskInp.on('keyup', function (e) {
			if (e.keyCode == 13) {
				let title = $(this).val();
				if (title.trim().leagth == 0) {
					alert('请输入内容');
					return;
				}
				$.post('/todo/addTask', { title }, () => {
					getList();
					taskInp.val('');
				});
			}
		});

		function render(tasks) {
			let html = template('taskTpl', {
				tasks
			});
			taskBox.html(html);
		}
		// 删除
		taskBox.on('click', '.destroy', function () {
			let _id = $(this).attr('data-id');
			$.get('/todo/deleteTask', { _id }, () => getList());
		});

		// 切换完成状态
		taskBox.on('change', '.toggle', function () {
			let completed = $(this).is(':checked');
			let _id = $(this).siblings('button').attr('data-id');
			$.post('/todo/modifyTask', { _id, completed }, () => getList());
		});

		// 双击出现 Input 框
		taskBox.on('dblclick', 'label', function () {
			$(this).parent().parent().addClass('editing');
			$(this).parent().siblings('input').val($(this).text()).focus();
		});
		// 离开 Input 框改变数据
		taskBox.on('blur', '.edit', function () {
			let title = $(this).val();
			let _id = $(this).siblings().find('button').attr('data-id');
			$.post('/todo/modifyTask', { _id, title }, () => getList(false));
		});

		// 计算数量
		function calcCount() {
			$.get('/todo/unCompletedTaskCount', res => strong.text(res.num));
		}

		// 完成状态切换
		$('.filters li').on('click', function () {
			$(this).addClass('selected').siblings().removeClass('selected');
		});

		// 底部切换会导致 hash 变化
		window.addEventListener('hashchange', function () {
			getList();
		});

		getList();

		function getList(isNeedCalc = true) {
			$.get(`/todo/${location.hash.substring(1)}`, function (res) {
				render(res);
				isNeedCalc && calcCount();
			});
		}

		function keepBtnStatus() {
			let num = location.hash === '#active' ? 1 : (location.hash === '#completed' ? 2 : 0);
			$('.filters li').eq(num).addClass('selected').siblings().removeClass('selected');
		}
		keepBtnStatus();

		$('.clear-completed').on('click', function () {
			$.get('/todo/clearTask', () => getList());
		});
	</script>
</body>

</html>